<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Identity Protocol — Preview</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2333;
    --border: #30363d;
    --text: #e6edf3;
    --muted: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --yellow: #d29922;
    --red: #f85149;
    --purple: #bc8cff;
    --gold: #f0c040;
    --platinum: #a8d8ea;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 14px; line-height: 1.6; }

  /* Layout */
  .shell { display: flex; min-height: 100vh; }
  .sidebar { width: 240px; min-width: 240px; background: var(--surface); border-right: 1px solid var(--border); padding: 20px 0; position: sticky; top: 0; height: 100vh; overflow-y: auto; }
  .main { flex: 1; padding: 32px 40px; max-width: 960px; }

  /* Sidebar */
  .logo { padding: 0 20px 20px; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
  .logo-badge { display: inline-flex; align-items: center; gap: 8px; font-weight: 700; font-size: 13px; color: var(--accent); }
  .logo-badge .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
  .logo p { font-size: 11px; color: var(--muted); margin-top: 4px; }
  .nav-section { padding: 0 12px 8px; }
  .nav-label { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; padding: 0 8px 6px; }
  .nav-item { display: flex; align-items: center; gap: 8px; padding: 7px 8px; border-radius: 6px; cursor: pointer; color: var(--muted); font-size: 13px; transition: all .15s; user-select: none; }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: rgba(88,166,255,.12); color: var(--accent); }
  .nav-item .icon { font-size: 15px; width: 18px; text-align: center; }
  .nav-item .badge { margin-left: auto; background: var(--surface2); color: var(--muted); font-size: 10px; padding: 1px 6px; border-radius: 10px; }

  /* Panels */
  .panel { display: none; }
  .panel.active { display: block; }
  h1 { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
  .subtitle { color: var(--muted); margin-bottom: 28px; font-size: 13px; }

  /* Stats row */
  .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 28px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
  .stat-card .label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
  .stat-card .value { font-size: 28px; font-weight: 700; line-height: 1.1; margin: 4px 0 2px; }
  .stat-card .sub { font-size: 11px; color: var(--muted); }
  .stat-card.blue .value { color: var(--accent); }
  .stat-card.green .value { color: var(--green); }
  .stat-card.yellow .value { color: var(--yellow); }
  .stat-card.purple .value { color: var(--purple); }

  /* Agent cards */
  .agents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .agent-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all .15s; }
  .agent-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(88,166,255,.1); }
  .agent-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
  .agent-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; flex-shrink: 0; }
  .agent-avatar.alice { background: linear-gradient(135deg, #1e3a5f, #0d5c97); color: #58a6ff; }
  .agent-avatar.bob { background: linear-gradient(135deg, #1e3d1e, #1a6b1a); color: #3fb950; }
  .agent-avatar.charlie { background: linear-gradient(135deg, #3d1e1e, #6b1a1a); color: #f85149; }
  .agent-name { font-weight: 600; font-size: 15px; }
  .agent-did { font-size: 11px; color: var(--muted); font-family: monospace; }
  .agent-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
  .chip { font-size: 11px; padding: 2px 8px; border-radius: 12px; font-weight: 500; }
  .chip.active { background: rgba(63,185,80,.15); color: var(--green); border: 1px solid rgba(63,185,80,.3); }
  .chip.inactive { background: rgba(248,81,73,.15); color: var(--red); border: 1px solid rgba(248,81,73,.3); }
  .chip.tier-gold { background: rgba(240,192,64,.15); color: var(--gold); border: 1px solid rgba(240,192,64,.3); }
  .chip.tier-silver { background: rgba(139,148,158,.15); color: var(--muted); border: 1px solid rgba(139,148,158,.3); }
  .chip.tier-unranked { background: rgba(248,81,73,.1); color: var(--red); border: 1px solid rgba(248,81,73,.2); }
  .score-bar-wrap { display: flex; align-items: center; gap: 10px; }
  .score-bar { flex: 1; height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .score-fill { height: 100%; border-radius: 3px; transition: width .4s ease; }
  .score-fill.gold { background: linear-gradient(90deg, #d29922, #f0c040); }
  .score-fill.silver { background: linear-gradient(90deg, #586069, #8b949e); }
  .score-fill.unranked { background: #f85149; }
  .score-num { font-size: 13px; font-weight: 600; min-width: 36px; text-align: right; }
  .score-num.gold { color: var(--gold); }
  .score-num.silver { color: var(--muted); }
  .score-num.unranked { color: var(--red); }

  /* Section heading */
  .section-head { font-size: 16px; font-weight: 600; margin-bottom: 14px; margin-top: 28px; display: flex; align-items: center; gap: 8px; }
  .section-head::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* Table */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 24px; }
  table { width: 100%; border-collapse: collapse; }
  th { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; padding: 10px 16px; border-bottom: 1px solid var(--border); text-align: left; }
  td { padding: 10px 16px; border-bottom: 1px solid rgba(48,54,61,.5); font-size: 13px; vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(48,54,61,.3); }
  .mono { font-family: monospace; font-size: 12px; color: var(--accent); }
  .status-dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; margin-right: 6px; }
  .status-dot.ok { background: var(--green); }
  .status-dot.warn { background: var(--yellow); }
  .status-dot.err { background: var(--red); }

  /* API Explorer */
  .endpoint-list { display: flex; flex-direction: column; gap: 10px; }
  .endpoint-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .endpoint-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer; user-select: none; transition: background .15s; }
  .endpoint-header:hover { background: var(--surface2); }
  .method { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; min-width: 42px; text-align: center; }
  .method.GET { background: rgba(63,185,80,.15); color: var(--green); }
  .method.POST { background: rgba(88,166,255,.15); color: var(--accent); }
  .endpoint-path { font-family: monospace; font-size: 13px; color: var(--text); flex: 1; }
  .endpoint-desc { font-size: 12px; color: var(--muted); }
  .chevron { color: var(--muted); transition: transform .2s; font-style: normal; }
  .chevron.open { transform: rotate(90deg); }
  .endpoint-body { display: none; border-top: 1px solid var(--border); }
  .endpoint-body.open { display: block; }
  .try-btn { display: inline-flex; align-items: center; gap: 6px; margin: 12px 16px; padding: 6px 14px; background: var(--accent); color: var(--bg); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: opacity .15s; }
  .try-btn:hover { opacity: .85; }
  .response-block { margin: 0 16px 16px; }
  .response-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
  .response-status { font-size: 11px; padding: 1px 8px; border-radius: 10px; background: rgba(63,185,80,.15); color: var(--green); }
  pre { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 14px; overflow-x: auto; font-size: 12px; line-height: 1.5; color: var(--text); max-height: 360px; overflow-y: auto; }
  .kw { color: var(--accent); }
  .str { color: #a5d6ff; }
  .num { color: #f0c040; }
  .bool-true { color: var(--green); }
  .bool-false { color: var(--red); }

  /* Score breakdown */
  .breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .breakdown-item { background: var(--surface2); border-radius: 8px; padding: 12px; }
  .breakdown-item .label { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .breakdown-item .val { font-size: 20px; font-weight: 700; }
  .breakdown-item.attest .val { color: var(--accent); }
  .breakdown-item.deleg .val { color: var(--purple); }
  .breakdown-item.actv .val { color: var(--green); }
  .breakdown-item.penalty .val { color: var(--red); }

  /* Risk flags */
  .risk-tag { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; padding: 3px 8px; border-radius: 4px; background: rgba(248,81,73,.12); color: var(--red); border: 1px solid rgba(248,81,73,.25); font-family: monospace; margin: 2px; }

  /* Detail panel */
  .detail-overlay { display: none; position: fixed; inset: 0; background: rgba(13,17,23,.8); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; }
  .detail-overlay.open { display: flex; }
  .detail-modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; width: 680px; max-width: 95vw; max-height: 90vh; overflow-y: auto; }
  .detail-top { display: flex; align-items: center; gap: 14px; padding: 24px; border-bottom: 1px solid var(--border); }
  .detail-body { padding: 24px; }
  .close-btn { margin-left: auto; background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 6px; }
  .close-btn:hover { background: var(--surface2); color: var(--text); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Responsive */
  @media (max-width: 720px) {
    .shell { flex-direction: column; }
    .sidebar { width: 100%; height: auto; position: static; }
    .stats { grid-template-columns: 1fr 1fr; }
    .main { padding: 20px; }
    .breakdown { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<div class="shell">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="logo">
      <div class="logo-badge"><span class="dot"></span>Agent Identity Protocol</div>
      <p>Beta_v18</p>
    </div>
    <div class="nav-section">
      <div class="nav-label">Overview</div>
      <div class="nav-item active" onclick="show('dashboard',this)"><span class="icon">⬡</span>Dashboard</div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Registry</div>
      <div class="nav-item" onclick="show('identities',this)"><span class="icon">◈</span>Identities <span class="badge" id="badge-identities">0</span></div>
      <div class="nav-item" onclick="show('credentials',this)"><span class="icon">◉</span>Credentials <span class="badge" id="badge-credentials">0</span></div>
      <div class="nav-item" onclick="show('delegations',this)"><span class="icon">⇌</span>Delegations <span class="badge" id="badge-delegations">0</span></div>
      <div class="nav-item" onclick="show('schemas',this)"><span class="icon">◫</span>Schemas <span class="badge" id="badge-schemas">0</span></div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Reputation</div>
      <div class="nav-item" onclick="show('reputation',this)"><span class="icon">◆</span>Scores</div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Developer</div>
      <div class="nav-item" onclick="show('api',this)"><span class="icon">⌨</span>API Explorer</div>
    </div>
  </nav>

  <!-- Main -->
  <main class="main">

    <!-- ── DASHBOARD ── -->
    <div id="panel-dashboard" class="panel active">
      <h1>Agent Identity Protocol</h1>
      <p class="subtitle">Decentralized identity &amp; composable reputation middleware for AI agents and smart accounts</p>

      <div class="stats">
        <div class="stat-card blue"><div class="label">Registered DIDs</div><div class="value" id="stat-dids">0</div><div class="sub" id="stat-chain">chain unknown</div></div>
        <div class="stat-card green"><div class="label">Active Credentials</div><div class="value" id="stat-credentials">0</div><div class="sub" id="stat-credentials-sub">—</div></div>
        <div class="stat-card yellow"><div class="label">Active Delegations</div><div class="value" id="stat-delegations">0</div><div class="sub">bitmask scoped</div></div>
        <div class="stat-card purple"><div class="label">Schemas</div><div class="value" id="stat-schemas">0</div><div class="sub" id="stat-schemas-sub">—</div></div>
      </div>

      <div class="section-head">Registered Agents</div>
      <div class="agents-grid" id="agents-grid"></div>
    </div>

    <!-- ── IDENTITIES ── -->
    <div id="panel-identities" class="panel">
      <h1>Identities</h1>
      <p class="subtitle">DID documents registered on-chain via DIDRegistry.sol</p>
      <div class="table-wrap">
        <table>
          <thead><tr><th>DID</th><th>Controller</th><th>Metadata CID</th><th>Block</th><th>Status</th></tr></thead>
          <tbody id="identities-body"></tbody>
        </table>
      </div>
      <p style="color:var(--muted);font-size:12px">DID format: <code style="background:var(--surface2);padding:1px 6px;border-radius:4px;font-family:monospace">did:agent:{chainId}:{address}</code></p>
    </div>

    <!-- ── CREDENTIALS ── -->
    <div id="panel-credentials" class="panel">
      <h1>Credentials</h1>
      <p class="subtitle">Verifiable attestations issued via AttestationRegistry.sol</p>
      <div class="table-wrap">
        <table>
          <thead><tr><th>UID</th><th>Schema</th><th>Issuer</th><th>Subject</th><th>Expires</th><th>Status</th></tr></thead>
          <tbody id="credentials-body"></tbody>
        </table>
      </div>
    </div>

    <!-- ── DELEGATIONS ── -->
    <div id="panel-delegations" class="panel">
      <h1>Delegations</h1>
      <p class="subtitle">Agent permission grants via DelegationRegistry.sol (bitmask scoped)</p>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ID</th><th>Owner</th><th>Agent</th><th>Scope</th><th>Expires</th><th>Status</th></tr></thead>
          <tbody id="delegations-body"></tbody>
        </table>
      </div>
      <p style="color:var(--muted);font-size:12px;margin-top:8px">Bitmask values: READ=1 · WRITE=2 · ATTEST=4 · DELEGATE=8 · combine: READ|WRITE=3 · full=15</p>
    </div>

    <!-- ── SCHEMAS ── -->
    <div id="panel-schemas" class="panel">
      <h1>Schemas</h1>
      <p class="subtitle">On-chain attestation schemas registered via SchemaRegistry.sol</p>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Name</th><th>Version</th><th>Creator</th><th>IPFS CID</th><th>Status</th></tr></thead>
          <tbody id="schemas-body"></tbody>
        </table>
      </div>
    </div>

    <!-- ── REPUTATION ── -->
    <div id="panel-reputation" class="panel">
      <h1>Reputation Scores</h1>
      <p class="subtitle">Multi-factor scores: Attestation 35% · Delegation 25% · Activity 25% · Penalty 15%</p>
      <div id="reputation-list"></div>
    </div>

    <!-- ── API EXPLORER ── -->
    <div id="panel-api" class="panel">
      <h1>API Explorer</h1>
      <p class="subtitle">Resolver REST API · base URL: <code style="background:var(--surface2);padding:2px 8px;border-radius:4px;font-family:monospace" id="base-url"></code></p>

      <div class="endpoint-list" id="endpoint-list"></div>
    </div>

  </main>
</div>

<!-- Agent detail modal -->
<div class="detail-overlay" id="detail-overlay" onclick="closeDetail(event)">
  <div class="detail-modal" id="detail-modal">
    <div class="detail-top" id="detail-top"></div>
    <div class="detail-body" id="detail-body"></div>
  </div>
</div>

<script>
function show(id, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  el.classList.add('active');
}

const state = {
  identities: [],
  schemas: [],
  credentials: [],
  delegations: [],
  profiles: new Map()
};

const baseUrl = new URLSearchParams(window.location.search).get('api') || 'http://localhost:3001';
const baseEl = document.getElementById('base-url');
if (baseEl) baseEl.textContent = baseUrl;

function shortAddress(value) {
  if (!value) return '—';
  const v = value.toLowerCase();
  if (!v.startsWith('0x') || v.length <= 10) return value;
  return `${v.slice(0, 6)}…${v.slice(-4)}`;
}

function parseChainId(did) {
  if (!did || !did.startsWith('did:')) return null;
  const parts = did.split(':');
  return parts.length > 2 ? parts[2] : null;
}

function formatDate(ms) {
  if (!ms) return '—';
  const d = new Date(ms);
  return d.toISOString().slice(0, 10);
}

function formatExpires(ms) {
  if (!ms) return 'never';
  return formatDate(ms);
}

function scopeLabel(scopeValue) {
  const scope = BigInt(scopeValue);
  const labels = [];
  if (scope & 1n) labels.push('READ');
  if (scope & 2n) labels.push('WRITE');
  if (scope & 4n) labels.push('ATTEST');
  if (scope & 8n) labels.push('DELEGATE');
  return labels.length ? labels.join(' | ') : 'NONE';
}

function statusDot(active) {
  return `<span class="status-dot ${active ? 'ok' : 'err'}"></span>${active ? 'active' : 'inactive'}`;
}

async function fetchJSON(path, opts) {
  const res = await fetch(baseUrl + path, opts);
  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || res.statusText);
  }
  return res.json();
}

function setText(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

function renderEmptyRow(targetId, cols, label) {
  const body = document.getElementById(targetId);
  if (!body) return;
  body.innerHTML = `<tr><td colspan="${cols}" style="color:var(--muted)"> ${label} </td></tr>`;
}

function renderAgents() {
  const grid = document.getElementById('agents-grid');
  if (!grid) return;
  grid.innerHTML = '';
  if (!state.identities.length) {
    grid.innerHTML = '<div class="stat-card" style="grid-column:1/-1;color:var(--muted)">No identities indexed</div>';
    return;
  }
  state.identities.forEach((identity) => {
    const profile = state.profiles.get(identity.did);
    const score = profile ? profile.score : 0;
    const tier = profile ? profile.tier : 'unknown';
    const tierCls = tier === 'gold' ? 'tier-gold' : tier === 'silver' ? 'tier-silver' : 'tier-unranked';
    const fillCls = tier === 'gold' ? 'gold' : tier === 'silver' ? 'silver' : 'unranked';
    const card = document.createElement('div');
    card.className = 'agent-card';
    card.onclick = () => openDetail(identity.did);
    const avatar = document.createElement('div');
    avatar.className = 'agent-avatar';
    const addr = identity.did.split(':').pop() || identity.did;
    avatar.textContent = addr.replace('0x', '').slice(0, 1).toUpperCase();
    const hash = [...addr].reduce((a, c) => a + c.charCodeAt(0), 0);
    avatar.style.background = `linear-gradient(135deg, hsl(${hash % 360}, 45%, 25%), hsl(${(hash + 60) % 360}, 60%, 35%))`;
    avatar.style.color = '#c9d1d9';
    const header = document.createElement('div');
    header.className = 'agent-header';
    const nameWrap = document.createElement('div');
    const nameEl = document.createElement('div');
    nameEl.className = 'agent-name';
    nameEl.textContent = `Agent ${shortAddress(addr)}`;
    const didEl = document.createElement('div');
    didEl.className = 'agent-did';
    didEl.textContent = identity.did;
    nameWrap.appendChild(nameEl);
    nameWrap.appendChild(didEl);
    header.appendChild(avatar);
    header.appendChild(nameWrap);
    const meta = document.createElement('div');
    meta.className = 'agent-meta';
    meta.innerHTML = `<span class="chip ${identity.active ? 'active' : 'inactive'}">${identity.active ? '● active' : '✕ inactive'}</span><span class="chip ${tierCls}">${tier.toUpperCase()}</span>`;
    const scoreWrap = document.createElement('div');
    scoreWrap.className = 'score-bar-wrap';
    scoreWrap.innerHTML = `<div class="score-bar"><div class="score-fill ${fillCls}" style="width:${Math.min(100, score)}%"></div></div><div class="score-num ${fillCls}">${score.toFixed(1)}</div>`;
    card.appendChild(header);
    card.appendChild(meta);
    card.appendChild(scoreWrap);
    grid.appendChild(card);
  });
}

function renderIdentities() {
  const body = document.getElementById('identities-body');
  if (!body) return;
  if (!state.identities.length) {
    renderEmptyRow('identities-body', 5, 'No identities indexed');
    return;
  }
  body.innerHTML = '';
  state.identities.forEach((row) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="mono">${row.did}</span></td>
      <td class="mono" style="font-size:11px">${shortAddress(row.controller)}</td>
      <td class="mono" style="font-size:11px">${row.metadataCid}</td>
      <td>—</td>
      <td>${statusDot(row.active)}</td>
    `;
    body.appendChild(tr);
  });
}

function renderCredentials() {
  const body = document.getElementById('credentials-body');
  if (!body) return;
  if (!state.credentials.length) {
    renderEmptyRow('credentials-body', 6, 'No credentials indexed');
    return;
  }
  const schemaMap = new Map(state.schemas.map((s) => [s.id, s.name]));
  body.innerHTML = '';
  state.credentials.forEach((row) => {
    const schemaName = schemaMap.get(row.schemaId) || row.schemaId;
    const expired = row.expiresAt && row.expiresAt < Date.now();
    const status = row.revoked ? 'revoked' : expired ? 'expired' : 'valid';
    const statusCls = row.revoked || expired ? 'err' : 'ok';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${row.uid}</td>
      <td>${schemaName}</td>
      <td class="mono" style="font-size:11px">${shortAddress(row.issuer)}</td>
      <td class="mono" style="font-size:11px">${row.subject}</td>
      <td>${formatExpires(row.expiresAt)}</td>
      <td><span class="status-dot ${statusCls}"></span>${status}</td>
    `;
    body.appendChild(tr);
  });
}

function renderDelegations() {
  const body = document.getElementById('delegations-body');
  if (!body) return;
  if (!state.delegations.length) {
    renderEmptyRow('delegations-body', 6, 'No delegations indexed');
    return;
  }
  body.innerHTML = '';
  state.delegations.forEach((row) => {
    const expired = row.expiresAt && row.expiresAt < Date.now();
    const active = !row.revoked && !expired;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${row.id}</td>
      <td class="mono" style="font-size:11px">${row.owner}</td>
      <td class="mono" style="font-size:11px">${shortAddress(row.agent)}</td>
      <td><span style="background:rgba(88,166,255,.12);color:var(--accent);padding:1px 7px;border-radius:4px;font-size:11px;font-family:monospace">${scopeLabel(row.scope)}</span></td>
      <td>${formatExpires(row.expiresAt)}</td>
      <td><span class="status-dot ${active ? 'ok' : 'err'}"></span>${active ? 'active' : 'inactive'}</td>
    `;
    body.appendChild(tr);
  });
}

function renderSchemas() {
  const body = document.getElementById('schemas-body');
  if (!body) return;
  if (!state.schemas.length) {
    renderEmptyRow('schemas-body', 5, 'No schemas indexed');
    return;
  }
  body.innerHTML = '';
  state.schemas.forEach((row) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${row.name}</strong></td>
      <td>${row.version}</td>
      <td class="mono" style="font-size:11px">${shortAddress(row.creator)}</td>
      <td class="mono" style="font-size:11px">${row.schemaCid}</td>
      <td><span class="status-dot ${row.active ? 'ok' : 'err'}"></span>${row.active ? 'active' : 'inactive'}</td>
    `;
    body.appendChild(tr);
  });
}

function renderReputation() {
  const list = document.getElementById('reputation-list');
  if (!list) return;
  list.innerHTML = '';
  if (!state.profiles.size) {
    list.innerHTML = '<div class="stat-card" style="color:var(--muted)">No reputation data available</div>';
    return;
  }
  state.identities.forEach((identity) => {
    const profile = state.profiles.get(identity.did);
    if (!profile) return;
    const tier = profile.tier.toUpperCase();
    const fillCls = profile.tier === 'gold' ? 'gold' : profile.tier === 'silver' ? 'silver' : 'unranked';
    const score = profile.score || 0;
    const section = document.createElement('div');
    section.innerHTML = `
      <div class="section-head">${identity.did} — ${tier} tier</div>
      <div class="breakdown">
        <div class="breakdown-item attest"><div class="label">Attestation (35%)</div><div class="val">${profile.scoreBreakdown.attestationScore.toFixed(1)}</div></div>
        <div class="breakdown-item deleg"><div class="label">Delegation (25%)</div><div class="val">${profile.scoreBreakdown.delegationScore.toFixed(1)}</div></div>
        <div class="breakdown-item actv"><div class="label">Activity (25%)</div><div class="val">${profile.scoreBreakdown.activityScore.toFixed(1)}</div></div>
        <div class="breakdown-item penalty"><div class="label">Penalty (15%)</div><div class="val">${profile.scoreBreakdown.penaltyScore.toFixed(1)}</div></div>
      </div>
      <div class="score-bar-wrap" style="margin-bottom:8px">
        <div class="score-bar"><div class="score-fill ${fillCls}" style="width:${Math.min(100, score)}%"></div></div>
        <div class="score-num ${fillCls}">${score.toFixed(1)} / 100</div>
      </div>
      <p style="color:var(--muted);font-size:12px;margin-bottom:16px">${profile.humanReadableExplanation}</p>
    `;
    if (profile.riskFlags && profile.riskFlags.length) {
      const flags = document.createElement('div');
      flags.style.marginBottom = '16px';
      flags.innerHTML = profile.riskFlags.map((f) => `<span class="risk-tag">⚠ ${f.description}</span>`).join(' ');
      section.appendChild(flags);
    }
    list.appendChild(section);
  });
}

function openDetail(did) {
  const profile = state.profiles.get(did);
  const identity = state.identities.find((i) => i.did === did);
  if (!profile || !identity) return;
  const isGold = profile.tier === 'gold';
  const isSilver = profile.tier === 'silver';
  const fillCls = isGold ? 'gold' : isSilver ? 'silver' : 'unranked';
  const score = profile.score || 0;
  const schemaMap = new Map(state.schemas.map((s) => [s.id, s.name]));
  document.getElementById('detail-top').innerHTML = `
    <div class="agent-avatar" style="width:48px;height:48px;font-size:22px;background:linear-gradient(135deg,#0b223a,#183a5a);color:#c9d1d9">${identity.did.replace('did:agent:', '').slice(-1).toUpperCase()}</div>
    <div>
      <div style="font-size:18px;font-weight:700">${identity.did}</div>
      <div style="font-family:monospace;font-size:12px;color:var(--muted)">${identity.controller}</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <span class="chip ${identity.active ? 'active' : 'inactive'}">${identity.active ? '● active' : '✕ inactive'}</span>
      <span class="chip ${fillCls === 'gold' ? 'tier-gold' : fillCls === 'silver' ? 'tier-silver' : 'tier-unranked'}">${profile.tier.toUpperCase()}</span>
    </div>
    <button class="close-btn" onclick="closeDetail()">✕</button>
  `;
  const creds = profile.credentials.map((c) => {
    const schemaName = schemaMap.get(c.schemaId) || c.schemaId;
    const status = c.revoked ? 'revoked' : c.expiresAt && c.expiresAt < Date.now() ? 'expired' : 'valid';
    const expires = formatExpires(c.expiresAt);
    return `${schemaName} (${status}, expires ${expires})`;
  });
  const delegs = profile.delegationChain.length
    ? profile.delegationChain.map((d) => `${shortAddress(d.agent)}: ${scopeLabel(d.scope)} ${d.expiresAt ? '— ' + formatExpires(d.expiresAt) : ''}`)
    : [];
  const flags = profile.riskFlags.length ? profile.riskFlags.map((f) => f.description) : [];
  const credsHtml = creds.length ? creds.map(c => `<li style="margin-bottom:4px">${c}</li>`).join('') : '<li style="color:var(--muted)">none</li>';
  const delegsHtml = delegs.length ? delegs.map(d => `<li style="margin-bottom:4px">${d}</li>`).join('') : '<li style="color:var(--muted)">none</li>';
  const flagsHtml = flags.length ? flags.map(f => `<span class="risk-tag">⚠ ${f}</span>`).join(' ') : '<span style="color:var(--green);font-size:12px">✓ no risk flags</span>';
  document.getElementById('detail-body').innerHTML = `
    <div style="margin-bottom:20px">
      <div style="font-size:11px;color:var(--muted);margin-bottom:6px">REPUTATION SCORE</div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <div style="font-size:36px;font-weight:800;color:var(--${isGold?'gold':isSilver?'muted':'red'})">${score.toFixed(1)}</div>
        <div style="flex:1"><div class="score-bar" style="height:10px;border-radius:5px"><div class="score-fill ${fillCls}" style="width:${Math.min(100, score)}%"></div></div></div>
        <div style="font-size:12px;color:var(--muted)">/100</div>
      </div>
      <p style="font-size:12px;color:var(--muted)">${profile.humanReadableExplanation}</p>
    </div>
    <div class="breakdown" style="margin-bottom:20px">
      <div class="breakdown-item attest"><div class="label">Attestation (35%)</div><div class="val">${profile.scoreBreakdown.attestationScore.toFixed(1)}</div></div>
      <div class="breakdown-item deleg"><div class="label">Delegation (25%)</div><div class="val">${profile.scoreBreakdown.delegationScore.toFixed(1)}</div></div>
      <div class="breakdown-item actv"><div class="label">Activity (25%)</div><div class="val">${profile.scoreBreakdown.activityScore.toFixed(1)}</div></div>
      <div class="breakdown-item penalty"><div class="label">Penalty (15%)</div><div class="val">${profile.scoreBreakdown.penaltyScore.toFixed(1)}</div></div>
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">Credentials</div>
      <ul style="list-style:none;padding:0;font-size:13px">${credsHtml}</ul>
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">Delegations granted</div>
      <ul style="list-style:none;padding:0;font-size:13px">${delegsHtml}</ul>
    </div>
    <div>
      <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">Risk flags</div>
      ${flagsHtml}
    </div>
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
      <div style="font-size:11px;color:var(--muted);margin-bottom:6px">Controller</div>
      <code style="font-size:12px;font-family:monospace;color:var(--accent)">${identity.controller}</code>
    </div>
  `;
  document.getElementById('detail-overlay').classList.add('open');
}

function closeDetail(e) {
  if (!e || e.target === document.getElementById('detail-overlay') || e.currentTarget.tagName === 'BUTTON') {
    document.getElementById('detail-overlay').classList.remove('open');
  }
}

function syntaxHighlight(json) {
  const s = typeof json === 'string' ? json : JSON.stringify(json, null, 2);
  return s.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g, match => {
    let cls = 'num';
    if (/^"/.test(match)) cls = /:$/.test(match) ? 'kw' : 'str';
    else if (/true/.test(match)) cls = 'bool-true';
    else if (/false/.test(match)) cls = 'bool-false';
    return `<span class="${cls}">${match}</span>`;
  });
}

function buildApiExplorer(endpoints) {
  const list = document.getElementById('endpoint-list');
  if (!list) return;
  list.innerHTML = '';
  endpoints.forEach((ep, i) => {
    const card = document.createElement('div');
    card.className = 'endpoint-card';
    card.innerHTML = `
      <div class="endpoint-header" onclick="toggleEndpoint(${i})">
        <span class="method ${ep.method}">${ep.method}</span>
        <span class="endpoint-path">${ep.path}</span>
        <span class="endpoint-desc">${ep.desc}</span>
        <i class="chevron" id="chev-${i}">›</i>
      </div>
      <div class="endpoint-body" id="body-${i}">
        <button class="try-btn" onclick="event.stopPropagation();runEndpoint(${i})">▶ Try it</button>
        <div class="response-block" id="resp-${i}" style="display:none">
          <div class="response-label">Response <span class="response-status" id="status-${i}">—</span></div>
          <pre id="pre-${i}"></pre>
        </div>
      </div>
    `;
    list.appendChild(card);
  });
  window.__endpoints = endpoints;
}

function toggleEndpoint(i) {
  const body = document.getElementById('body-' + i);
  const chev = document.getElementById('chev-' + i);
  const open = body.classList.toggle('open');
  chev.classList.toggle('open', open);
}

async function runEndpoint(i) {
  const ep = window.__endpoints[i];
  const respDiv = document.getElementById('resp-' + i);
  const pre = document.getElementById('pre-' + i);
  const statusEl = document.getElementById('status-' + i);
  respDiv.style.display = 'block';
  try {
    const result = await ep.run();
    statusEl.textContent = '200 OK';
    pre.innerHTML = syntaxHighlight(result);
  } catch (error) {
    statusEl.textContent = 'ERROR';
    pre.innerHTML = syntaxHighlight({ error: String(error) });
  }
}

async function loadData() {
  try {
    const [identities, schemas, credentials, delegations] = await Promise.all([
      fetchJSON('/identities'),
      fetchJSON('/schemas'),
      fetchJSON('/credentials'),
      fetchJSON('/delegations')
    ]);
    state.identities = identities || [];
    state.schemas = schemas || [];
    state.credentials = credentials || [];
    state.delegations = delegations || [];
    const chainId = state.identities.length ? parseChainId(state.identities[0].did) : null;
    setText('stat-dids', String(state.identities.length));
    setText('stat-schemas', String(state.schemas.length));
    setText('stat-schemas-sub', state.schemas.slice(0, 3).map(s => s.name).join(' · ') || '—');
    setText('stat-chain', chainId ? `chain ${chainId}` : 'chain unknown');
    setText('badge-identities', String(state.identities.length));
    setText('badge-credentials', String(state.credentials.length));
    setText('badge-delegations', String(state.delegations.length));
    setText('badge-schemas', String(state.schemas.length));
    const now = Date.now();
    const activeCredentials = state.credentials.filter((c) => !c.revoked && (!c.expiresAt || c.expiresAt > now));
    const activeDelegations = state.delegations.filter((d) => !d.revoked && (!d.expiresAt || d.expiresAt > now));
    setText('stat-credentials', String(activeCredentials.length));
    setText('stat-credentials-sub', `${state.credentials.length} total`);
    setText('stat-delegations', String(activeDelegations.length));
    const profiles = await Promise.all(state.identities.map((i) =>
      fetchJSON(`/identity/${encodeURIComponent(i.did)}/trust-profile`).catch(() => null)
    ));
    profiles.forEach((p) => {
      if (p && p.did) state.profiles.set(p.did, p);
    });
    renderAgents();
    renderIdentities();
    renderCredentials();
    renderDelegations();
    renderSchemas();
    renderReputation();
    buildApiExplorer(buildEndpointList());
  } catch (error) {
    renderEmptyRow('identities-body', 5, 'Failed to load data');
    renderEmptyRow('credentials-body', 6, 'Failed to load data');
    renderEmptyRow('delegations-body', 6, 'Failed to load data');
    renderEmptyRow('schemas-body', 5, 'Failed to load data');
  }
}

function buildEndpointList() {
  const sampleDid = state.identities[0]?.did;
  const sampleSchema = state.schemas[0]?.id;
  return [
    {
      method: 'GET',
      path: '/health',
      desc: 'Server health check',
      run: () => fetchJSON('/health')
    },
    {
      method: 'GET',
      path: '/identities',
      desc: 'List all identities',
      run: () => fetchJSON('/identities')
    },
    {
      method: 'GET',
      path: sampleDid ? `/identity/${sampleDid}` : '/identity/:did',
      desc: 'Resolve a DID document',
      run: () => sampleDid ? fetchJSON(`/identity/${encodeURIComponent(sampleDid)}`) : Promise.resolve({ error: 'No identities indexed' })
    },
    {
      method: 'GET',
      path: sampleDid ? `/identity/${sampleDid}/trust-profile` : '/identity/:did/trust-profile',
      desc: 'Trust profile with reputation',
      run: () => sampleDid ? fetchJSON(`/identity/${encodeURIComponent(sampleDid)}/trust-profile`) : Promise.resolve({ error: 'No identities indexed' })
    },
    {
      method: 'GET',
      path: '/credentials',
      desc: 'List all credentials',
      run: () => fetchJSON('/credentials')
    },
    {
      method: 'GET',
      path: '/delegations',
      desc: 'List all delegations',
      run: () => fetchJSON('/delegations')
    },
    {
      method: 'GET',
      path: '/schemas',
      desc: 'List all schemas',
      run: () => fetchJSON('/schemas')
    },
    {
      method: 'GET',
      path: sampleSchema ? `/schema/${sampleSchema}` : '/schema/:id',
      desc: 'Get a schema by id',
      run: () => sampleSchema ? fetchJSON(`/schema/${encodeURIComponent(sampleSchema)}`) : Promise.resolve({ error: 'No schemas indexed' })
    },
    {
      method: 'GET',
      path: sampleDid ? `/reputation/${sampleDid}` : '/reputation/:subject',
      desc: 'Reputation score',
      run: () => sampleDid ? fetchJSON(`/reputation/${encodeURIComponent(sampleDid)}`) : Promise.resolve({ error: 'No identities indexed' })
    },
    {
      method: 'POST',
      path: '/reputation/verify',
      desc: 'Verify a reputation proof',
      run: async () => {
        if (!sampleDid) return { error: 'No identities indexed' };
        const score = await fetchJSON(`/reputation/${encodeURIComponent(sampleDid)}`);
        const body = {
          subject: score.subject,
          score: score.score,
          merkleRoot: score.proof.merkleRoot,
          proof: score.proof.proof,
          timestamp: score.proof.timestamp
        };
        return fetchJSON('/reputation/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
      }
    }
  ];
}

loadData();
</script>
</body>
</html>
